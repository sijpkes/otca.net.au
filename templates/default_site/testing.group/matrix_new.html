{embed="testing/matrix_header"}

<body>
<div class="row-fluid">
<div class='span4 fixed_220w' id='portfolio_interface'>
<H2>Snapshots</H2>
	<ul>
    </ul>
</div>
<div class='span8' id='matrix_interface' style='margin-left: 228px'>
<h2>The Occupational Therapy Competencies Evidencing Matrix (OTCEM)</h2>
	<div class='evidencing-app' style='margin: 0; border: none'>
	{exp:channel:entries channel="evidencing_matrix" limit="10" orderby="title" sort="asc" dynamic="no"}
				<p>{text_body}</p>
	{/exp:channel:entries}	
	</div>
</div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="/js/rainbow-vis.js"></script>
<script src="/js/libs/bootstrap.min.js"></script>


<script>
//return false;
// sample userProfile

		
   (function( $ ) {   
$.fn.evidencing = function() {
	
	var $me = this;
	var entry_id = "add_evidence";
	// last search results
	var $searchResults = null;
	
	jQuery.expr[":"].Contains = jQuery.expr.createPseudo(function(arg) {
	    return function( elem ) {
	        return jQuery(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;
    	    };
	});
	
	/* setup table drop-down selector -updated */
	$me.prepend("View the OTPP Step <select id='table-nav'></select>");
			
	/* setup file viewer window and ajax loader */
	$("body").append("<div class='file-viewer upload-box' style='display: none;'> </div>");
	$("body").append("<div class='file-viewer dialog' style='display: none;'><a href='#close' class='exit'><img src='/img/close-icon.png' alt='close'></a><span id='message'></span></div>");
	$me.append("<div class='file-viewer pracsot' style='display: none;'>\
				</div>");
	$me.append("<div class='ajax-loader' style='display: none;'> </div>");

	var $viewer = $('div.file-viewer.upload-box');
	var $pracsot_viewer = $('div.file-viewer.pracsot');
	var $dialog = $('div.file-viewer.dialog');
		
	var leveln = userProfile.level;
	levelName = "Emerging";
	
	switch(leveln) {
	case 1:
		levelName='Emerging';
	break;
	case 2:
		levelName='Consolidating';
	break;
	case 3:
		levelName = "Competent to Graduate";
	}
	
	var radioCount = 0;	
	/* verified matrix version */
	$.fn.addCheckBoxes = function(stepn) {
	    if(entry_id == 'guest') return false;
	    
	    var checkSelfAssessed = function(criteria) { 
	    var bgcolor = '';
		var text_color = '';
		
		var str = "";
		var selfChecked = false;
	    if(typeof self_assessed_item !== 'undefined' && self_assessed_item !== false) {
			$(self_assessed_item).each(function(saindex, saobject) { 
			if(typeof saobject.self_assessment !== 'undefined' && saobject.self_assessment.length > 0) {
				var statements = JSON.parse(saobject.self_assessment);
				var item = saobject;
				$(statements).each(function() {
				
				if(criteria.step == this.step &&
					criteria.row == this.row &&
					criteria.level == this.level &&
					criteria.checkbox == this.checkbox
				) {	
					// only 1 tick per criteria
					if(str.length==0) {
						
						selfChecked = true;
						bgcolor = "ccffcc";
						str +=  "<a href='#'>"+item.title +"   you ticked this on<br>    "+ item.entry_date+"</a>";
					}
				}
				});
			}
			});
			}
			
			return { assessorsStr : str, wasAssessed : false, isChecked : selfChecked, highlightColor: bgcolor, textColor: "000000"};			
	    };
	    
	    
		var verifyCheckBox = function(criteria) {
		
		var bgcolor = '';
		var text_color = '';
		
		var str = "";
			var wasAssessed = false;
			var selfChecked = false;
			var assessor_agreed = false;
			//console.log(">>>>>>>>>>>>>>> "+self_assessed_item.self_assessment);
			if(typeof self_assessed_item !== 'undefined' && self_assessed_item !== false) {
			$(self_assessed_item).each(function(saindex, saobject) { 
			if(typeof saobject.self_assessment !== 'undefined' && saobject.self_assessment.length > 0) {
				var statements = JSON.parse(saobject.self_assessment);
				var item = saobject;
				$(statements).each(function() {
				
				//console.log(this);
				if(criteria.step == this.step &&
					criteria.row == this.row &&
					criteria.level == this.level &&
					criteria.checkbox == this.checkbox
				) {	
					// only 1 assessor per criteria
					if(str.length==0) {
						wasAssessed = false; 
						bgcolor = "042C6D";
                        text_color = "FFD500";
					
				var radioButtons = "This competency statement has not yet been verified by a supervisor.<br>";
				radioCount++;
				selfChecked = true;
				str += radioButtons;
				console.log('entry_id '+entry_id+'item.entry_id '+item.entry_id);
				if(!item.is_current_entry) {
				str += "<br><a class='matrix-nav-link' title=''  style='color: #"+text_color+"' href='/pages/assessed-matrix/"+item.entry_id+"/"+item.title+"/"+item.level+"/"+item.step+"'>View Unverified OTCEM Self-Assessment<br>\""+ 
				        item.title +"\"   self-assessed on<br>    "+ item.entry_date+"</a>";
				}
						//str += item.screen_name + ", <a style='color:"+bgcolor+"' href='mailto:"+item.email+"'>"+item.email+"</a>";
					}
				}
				});
			}
			});
			}
			if(typeof assessed_items !== 'undefined' && assessed_items.length > 0) {
				
				var lastDate = 0;
				var current_assessed_item_filter = $(assessed_items).filter(
				function(a) {
					return (this.is_current_entry);
				}
				);
				
				$(current_assessed_item_filter).each(function() {
				var item = this;
				var statements = JSON.parse(this.supervisor_assessment);
				$(statements).each(function() {
				if(criteria.step == this.step &&
					criteria.row == this.row &&
					criteria.level == this.level &&
					criteria.checkbox == this.checkbox
				) {
					
					/* 	Only 1 assessor per criteria
					* 	This will only place the top item in the 'assessed item' array in the statement box.
					*	The array is sorted in descending raw sql date order in the SQL statement, so the last
					*	assessment will always be on top.
					*/		
					if(str.length==0) {
						wasAssessed = true;
						bgcolor = "FFB510";
						text_color = "161500";
						var agreed;
						var disagreed;
						if(typeof this.agreed !== 'undefined') {
							agreed = this.agreed == 1 ? "checked" : "";
							disagreed = this.agreed != 1 ? "checked" : "";
						} else {
							agreed = "checked";
							disagreed = "";
						}
						assessor_agreed = (this.agreed == 1);	
				var radioButtons = "Agree: <input type='radio' value='1' name='radio"+radioCount+"' "+agreed+" disabled='disabled'> Disagree: <input value='0' type='radio' name='radio"+radioCount+"' "+disagreed+" disabled='disabled'><br>";
				radioCount++;
						str += radioButtons + "Assessed by: "; 
						str += item.screen_name + ", <a style='color:#"+text_color+"' href='mailto:"+item.email+"'>"+item.email+"</a>";
					}
				}
				});
			});
			
			var other_assessed_item_filter = $(assessed_items).filter(
					function(a) {
						return (!this.is_current_entry);
					}
			);
			
				$(other_assessed_item_filter).each(function() {
					var item = this;
					var statements = JSON.parse(this.supervisor_assessment);
					$(statements).each(function() {
					if(criteria.step == this.step &&
						criteria.row == this.row &&
						criteria.level == this.level &&
						criteria.checkbox == this.checkbox
					) {

						// only 1 assessor per criteria
						if(str.length==0) {
							wasAssessed = true;
							bgcolor = "852C8A";
							text_color = "F7F7FB";
							var agreed = this.agreed == 1 ? "checked" : "";
							var disagreed = this.agreed != 1 ? "checked" : "";
							assessor_agreed = (this.agreed == 1);	
					var radioButtons = "Agree: <input type='radio' value='1' name='radio"+radioCount+"' disabled='disabled' "+agreed+"> Disagree: <input type='radio' value='0' name='radio"+radioCount+"' disabled='disabled' "+disagreed+"><br>";
					radioCount++;
							str += radioButtons + "Assessed by: "; 
							str += item.screen_name + ", <a style='color:#"+text_color+"' href='mailto:"+item.email+"'>"+item.email+"</a><br>";
							str += "<br><a class='matrix-nav-link' title='' style='color: #"+text_color+"' href='/pages/assessed-matrix/"+item.entry_id+
							         "/"+item.title+"/"+item.level+"/"+item.step+"'>View Previously Verified OTCEM Self-Assessment<br>\""+ 
							         item.title +"\"   added on<br>   "+ item.entry_date+"</a>";
						}
					}
					});
					
				});
			}
			var isChecked = wasAssessed ? assessor_agreed : selfChecked; 
			return { assessorsStr : str, wasAssessed : wasAssessed, isChecked : isChecked, highlightColor: bgcolor, textColor: text_color};			
			};

	/* main part of the function that traverses the table and adds meta data */
	var rowspan = 0;
	var boxesAssessed = [];
	this.find('tbody tr').each(function(rowi, rowo) {
	if(rowi > 2) {
		var nocells = $('td', rowo).length;
		$(rowo).find('td').each(function(coli, colo) {

			if(! (nocells == 4 && coli == 0) ) {// skip column headers
						$(colo).find('p').each(function(cbi, cbo) {
							var cblevel = stepn == 0 ? coli+1 : coli;			
							var criteria = { step: stepn, row: rowi, level: cblevel, checkbox: cbi, pracsot: 'empty' };
							var checked;
							var assessed;
							
							if(USE_VERIFICATION === true) {
								var assessCheck = verifyCheckBox(criteria);			
								assessed = "<p style='color: #"+assessCheck.textColor+"; background-color: #"+assessCheck.highlightColor+"; font-size: 12px; padding: 4px'>  "+assessCheck.assessorsStr+"</p>";
								checked =  assessCheck.isChecked?"checked":"";
							} else {
								var selfAssessed = checkSelfAssessed(criteria);
								assessed = "<p style='color: #"+selfAssessed.textColor+"; background-color: #"+selfAssessed.highlightColor+"; font-size: 12px; padding: 4px'>  "+selfAssessed.assessorsStr+"</p>";
								checked = selfAssessed.isChecked?"checked":"";
							}	
							var criteriaStr = JSON.stringify(criteria);
							$(cbo).html("<label><input type='checkbox' id='c"+stepn.toString()+rowi.toString()+coli.toString()+cbi.toString()+"' data-criteria='"+criteriaStr+"' "+checked+">"+$(this).text()+assessed+"</label>");
							//if(assessCheck.wasAssessed || assessCheck.isChecked) { $(cbo).css({'border':'1px solid '+assessCheck.highlightColor}); }
						});
			}
		});
	}
	});
	};
	
	$.fn.removeCriteria = function() {
		$me.find('div.popup').remove();
		return this;
	};
	
	$.fn.showCriteria = function() {
		$me.mydiv = this.clone();
		var l = this.offset().left; // get UI offsets
		var t = this.offset().top;
		if($me.mydiv.hasClass("file-info")) {
			$me.mydiv.removeClass("file-info");
			$me.mydiv.addClass('popup');
			$me.mydiv.html("");
		}
		
		$.each(this.data('crit'), function(i, o) {
				var stepn = o[0];
				var rown = o[1];
				var coln = o[2];
				var cbxn = o[3];	
				console.log(o.toString());
		//if(window.anchor == undefined) window.anchor = window.mydiv.html();
		
			$me.find('tbody').each(function(tablei, table) {
			if(tablei+1 == stepn) {
				$(table).find('tr').each(function(rowi, rowo){
				if(rowi == rown) {
						$(rowo).find('td').each(function(coli, colo) {
							if(coli == coln) {
										$(colo).find('p').each(function(cbi, cbo) {
											if(cbi == cbxn) {
												$me.mydiv.append("<p class='criteria'>"+$(cbo).html()+"</p>");
												$me.mydiv.find("input").remove();
											}
										});
							}
						});
				}
				});
			}
		});
			});	

		$me.append($me.mydiv);	
		$me.mydiv.offset({ top : t+10, left : l+300 });
		
		return this;
	};

	$.fn.setSelectedTab = function() {
		$($me.currentTableView).hide();
		$($me.currentTableView).css('border-width','thin');
					
		$me.lastTabSelected = this;
		
		var tableid = this.find('option:selected').data('tableid');
		
		$me.currentTableView = $('table').get(tableid);
		$($me.currentTableView).css('border-width', '3px');
		$($me.currentTableView).show();
		
		return this;
	};
	
	/* add feedback and assessment date, assessor name*/
	var wasAssessed = false;
	var acount = 0;	
	if(typeof assessed_items !== 'undefined') {
		
		$(assessed_items).each(function(){
			
			if(this.is_current_entry)  { 
				$("#notAssessed").remove();
				wasAssessed = true;
				var asssed_by_str = acount === 0 ? "Last Assessed by:  " : "Previously Assessed by:  ";
				$(".feedback p:nth-of-type(2) ").before("<strong style='color: blue'>"+asssed_by_str+this.screen_name+" on: "+this.date_assessed+"</strong><br><br>"+this.feedback+"<br><br>");
				acount++;
			}
		});
	}
	
	if(!wasAssessed && $.type(entry_id) !== 'string') {
		$(".feedback").append("<strong style='color: red' id='notAssessed'>This evidence has not yet been assessed.</strong>");
	}
		
	$me.find('table').each(function(i,o) {
		if(i>0)  {
			$(o).hide();
		}
		else {
			$me.currentTableView = o;
			$($me.currentTableView).show();
		}
		
		console.log('table n = '+i);
		$(o).addCheckBoxes(i);
		
		var selectTxt = "";
		if(i==0) { selectTxt = "Being a Professional"; } else { selectTxt = "Step "+i+" - "+window.stepDefinitions[i]; }
		
		$me.find("select#table-nav").append("<option data-tableid='"+i+"' value='"+i+"'>"+selectTxt+"</option>");
	});
	/*
		removes duplicate entries in array1 from array2
	*/
	var removeDuplicates = function(array1, array2){
		$(array2).each(function(i, v) {
			var loc = array1.indexOf(v);
			if(loc != -1) {
				array1.splice(loc, 1);
			}
		});
			
	return array1;
	};
	
	$.fn.additionalCellInfo = function(selectedTableId) {
	//console.log('called '+$(this).data('pracsot'));
	
	if($("span", this).length == 0) {
	    var pracsotChck = $(this).data('pracsot');
			if(typeof pracsotChck === 'undefined') return false;
			var pracsotArr = $(this).data('pracsot').split(',');
			
			var level = $(this).closest('td').index();
			var cellCount = $(this).closest('td').parent().find("td").length;
			
			if(cellCount == 3) {
				level = level + 1;				
			}
			
			var row = $(this).closest("tr").index()-2;
				
			var pracsotStr = selectedTableId == 0 ? "" : "<span><br><a id='behaviours' data-level='"+level+"' data-row='"+row+"' href='#'>Observed behaviours</a></span>";
			pracsotStr += "<span id='pracsot-crit'><br><br>PRACSOT Performance Criteria:<br>";
			var comma = "";
			$(pracsotArr).each(function(i, v) {
				if(i > 0) comma = ", ";
				pracsotStr += comma+"<a class='getPracsot' href='"+pracsotChck+"'>"+v+"</a>";
			});
			
			pracsotStr += "</span>";
			$(this).append(pracsotStr);
	}
	return this;
	};
	
	$.fn.addTableRow = function(step, level, statement) {
		if(statement.text().length == 0) { return this; }
			
		var rowspanned = isNaN($(this).data('rows-spanned'))?1:$(this).data('rows-spanned');
		var prev = String($(this).data('prev-step'));
		
		if(step != null && prev == step) {
			$(this).find('td#firstCol').last().attr('rowspan', ++rowspanned);
			$(this).append("<tr><td>"+level+"</td></tr>").find('td').last().after(statement);
		} else {
			rowspanned = 1;
			$(this).append("<tr><td id='firstCol'>"+step+"</td><td>"+level+"</td></tr>").find('td').last().after(statement);
		}
		
		$(this).find('p').last().wrap('<td />');
		
		$(this).data('prev-step', step);
		$(this).data('rows-spanned', rowspanned); 
		return this;
	};
	
	$(document).on('click', 'span > a#behaviours', function(e) {
		e.preventDefault();
		$("div.ajax-loader").show();
		var $dialog = $('div.file-viewer.dialog');
		$dialog.css({ width: "400px", height : "auto", left: "546px", top: "499px", maxHeight: "400px", overflow: "auto" });
		
		var level = $(this).data('level');
		var step = $("#table-nav option:selected").data("tableid");
		var row = $(this).data('row'); // don't include header rows
		
		$("#message", $dialog).load("/ajax/get-behaviours/"+step+"/"+level+"/"+row, function() {
			$dialog.show(250);
			$("div.ajax-loader").hide();
		});
	
	});
	
	var resetSearch = function() {
		$('input[name=search]').val('');
		$("table#searchResults").fadeOut().remove();
		$($me.currentTableView).fadeIn();
	};
	
	$me.find('button#clearSearch').click(function(e) {
		resetSearch();
	});
	
	$me.on('change','input[name=search]', function(e) {
		if($(this).val().length == 0) {
			resetSearch();
			return;
		}
		$("table#searchResults").fadeOut().remove(); //reset previous search
		
		var s = $(e.target).val().trim().toLowerCase();
		
		var searchTermArray = s.split(" ");
		var pracArray = s.match(/([1-99]*\.?)+/g);
		
		var resultTable = "<table id='searchResults' style='display: none'><tr><th>Step</th><th>Level</th><th>Competency Statement</th></tr></table>";
		$me.find('.file-viewer').first().before(resultTable);
		
		var numResults = 0
		// check for pracsot codes if they exist in search
		if(typeof pracArray != 'undefined' && pracArray != null && pracArray.length > 0) {
			$me.find('table td p').each(function(i, o) {
				for(var j=0;j<pracArray.length;j++) {
					if(pracArray[j].length > 0) {
					if(typeof $(o).data('pracsot') != 'undefined') {
						if($(o).data('pracsot').indexOf(pracArray[j]) != -1) {
							var crit = $(o).find('input').data('criteria');
							if(typeof crit != 'undefined') {
								if(crit.level != 0 && $(o).text().length > 0) {
									$('table#searchResults').addTableRow(window.stepDefinitions[crit.step+1], crit.level, $(o).clone());
									++numResults;
								}
							}
						}
					}
				}	
				}
			});
		}
	
	searchTermArray = removeDuplicates(searchTermArray, pracArray);
	
	$.each(searchTermArray, function(i, s) {
			if(numResults == 0) {
					$me.find('table td p:Contains('+s+')').each(function(i, o) {
						var crit = $(o).find('input').data('criteria');
						if(typeof crit != 'undefined') {
							if(crit.level != 0 && $(o).text().length > 0) {
								$('table#searchResults').addTableRow(window.stepDefinitions[crit.step+1], crit.level, $(o).clone());
								++numResults;
							}
						}
					});
			} else {
					$('table#searchResults td p:not(:Contains("'+s+'"))').closest('tr').remove();
					numResults = $('table#searchResults tr').length-1;
			}
	});
	
	if(numResults < 1) {
		$('table#searchResults').append('<tr><td colspan=3>No results found.</td></tr>');
	}		
	$me.find('table').hide();
	$('table#searchResults').fadeIn();
	});
	
	$me.on('change', "select#table-nav", function(e) 
	{
		$(e.target).setSelectedTab();
	});    
	
/*
 *The MIT License (MIT)
 *
 *Copyright (c) 2013 Paul Sijpkes.
 *
 *Permission is hereby granted, free of charge, to any person obtaining a copy
 *of this software and associated documentation files (the "Software"), to deal
 *in the Software without restriction, including without limitation the rights
 *to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *copies of the Software, and to permit persons to whom the Software is
 *furnished to do so, subject to the following conditions:
 *
 *The above copyright notice and this permission notice shall be included in
 *all copies or substantial portions of the Software.
 *
 *THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *THE SOFTWARE.
 */
window.saveStepStr = "";
window.saveLevelStr = "";
window.saveStepArr = [];
window.saveLevArr = [];

/* @TODO: allow removal of items as well */

var genStepLevel = function(o) {
    if ($.inArray(o.step, saveStepArr) == -1) {
        if (saveStepArr.length > 0)
            saveStepStr += ", ";

        saveStepStr += stepDefinitions[o.step == 0 ? 8 : o.step];
        saveStepArr.push(o.step);
    }
    
    /* Levels only apply for steps higher then 0 (Being a Professional)*/
    if (o.step > 0) {
        switch(o.level) {
            case 1:
                levelName = 'Emerging';
                break;
            case 2:
                levelName = 'Consolidating';
                break;
            case 3:
                levelName = "Competent to Graduate";
        }

        if ($.inArray(levelName, saveLevArr) == -1) {
            if (saveLevArr.length > 0)
                saveLevelStr += ", ";

            saveLevelStr += levelName;
            saveLevArr.push(levelName);
        }
    }
};
	

	var add_evidence = function() {
		
		//$("td input[type='checkbox']").removeAttr('disabled').removeAttr('checked');
		
		/* add tag data containing user instructions for the OTCEM*/
		$('select#table-nav').first().after("\n\n");  
		
		if(entry_id != 'add_evidence') {
			$(".contrast p").first().after("<p style='font-size: 14pt'><a href='#' id='cancel' style='color: #639'>Cancel upload of evidence and refresh.</a></p>");
		}
		
		$me.on('click', '#cancel', function(e) {
			e.preventDefault();
			window.location.reload();
		});
		
		$(document).on('click', '#save_otcem', function(e) {
		e.preventDefault();
		
		var data = getCheckedCrit();
		var	sData = makeSearchable(data[0]);
		var pracsotStr = data[2].join(',');	
		
		var critJSONdata = [];
		
		$.each(data[0], function(i, o) {
			critJSONdata.push(o);
			genStepLevel(o);
		});
					
		$viewer.load('/pages/evidence-upload', 
		function() { 
		        $viewer.find("form#publishForm #step").text(window.saveStepStr);  
		        $viewer.find("form#publishForm #level").text(window.saveLevelStr);  
			    $viewer.find("form#publishForm #criteria_mapping").text(JSON.stringify(critJSONdata));
			    $viewer.find("form#publishForm #searchable_mapping").text(JSON.stringify(sData));
				$viewer.find('form#publishForm textarea#supervisor_emails').after("<input id='emailMe' name='emailMe' type='checkbox'/><label for='emailMe'>Send me a copy of this email.</label>");
			    $viewer.find("form#publishForm input[name='cycle_name']").val(window.userProfile.title);
			    
			    $viewer.find("form#publishForm input[type='submit']").before("<p>When you click 'Save', this OTCEM Self assessment and any uploaded items,\
			    will be uploaded as fulfilling<br> <strong>Step(s): "+window.saveStepStr+"<br>Level(s): "+window.saveLevelStr+" </strong></p>");
			    $viewer.show();
			    
				$("div.ajax-loader").hide();
				
				$viewer.find('#supervisor_emails').hide().before("<input id='asminput' name='asminput'></input><button id='addsup'>Add supervisor</button><br><ul id='emailList'></ul>");
				var supArray = [];
				$(this).on('click','#addsup', function(e) {
					e.preventDefault();	
					var email = $('#asminput').val();
					if(0 == email.length) return false;
					var i = supArray.indexOf(email);
					if(-1 == i) { 
						i = supArray.push(email)-1;
						$('#emailList').append('<li data-index="'+i+'">'+email+'   <a href="#">Remove</a></li>');
						$('#supervisor_emails').val(supArray.join());
					} else {
						$('#emailList li').each(function(li_index, v){
							if($(v).data('index') == i) {
								//$(v).fadeOut(1000).fadeIn(1000);
								$(v).fadeOut(20).queue(function(next) {$(this).css({'background-color': '#FFF', 'border-color':'yellow'}); next();}).fadeIn(100).delay(50).queue(function(next) { $(this).css({'background-color': 'inherit', 'border-color': '#aaa'}); next(); });
							}
						});
					}
					return false;
				});

				$(this).on('click', 'ul#emailList a', function(e) { 
					e.preventDefault();
					var index = $(this).parents('li').data('index');
					supArray.splice(index, 1);
					$(this).parents('li').remove();
					$('#supervisor_emails').val(supArray.join());
				});
			    
			     $('.feedback, .evidencing-app').fadeTo('slow', 0.3);   
			     
			    $viewer.find('#publishForm').ajaxForm({
			        dataType: 'json',
			        success: function(data) {
			                if (data.success) {
								//alert(pracsotStr);
								var fullPath = $("div.safecracker_file_input input[name='evidence']").val();
								var filename = fullPath.replace(/^.*[\\\/]/, '');
								
								// emails now sent via share interface
								$.get('/ajax/map-evidence?id='+data.entry_id+"&filename="+filename, function(data) {
									var jsonData = JSON.parse(data);
									
									$viewer.html("");
									$viewer.hide();
									$dialog.css({ width: "400px", height : "220px", left: "546px", top: "499px" });
									
									var strLinks = "<p><a class='button' href='/practice-placement/summary-of-your-competencies?show="+jsonData.id+"'>View this OTCEM Self-Assessment in your ePortfolio</a></p>";
									strLinks += "<p><a class='button' href='javascript:document.location.reload(true);' >Add another OTCEM Self-Assessment</a></p>";
									
									$dialog.find('span#message').html("<h3>Upload Successful</h3>"+jsonData.message+strLinks);
									$dialog.show(250);
									$("div.ajax-loader").hide();
								});
								
			                } else {
			                        var str = "<p>The following errors with your form were reported:<br>";

								    $('input, textarea').each(function(i,v){
								    var id = $(v).attr('id');
								    if(typeof data.field_errors[id] != 'undefined') {
								    	str += data.field_errors[id]+"<br>";
								    		$(v).css({ "background-color" : "yellow" });
								    	} else {
								    		$(v).css({ "background-color" : "none" });	
								    	}
								    });
								    str += "</p>";
								
								   $dialog.find('span#message').html(str);
								   $dialog.show(250); 
								   $('.feedback, .evidencing-app').fadeTo('slow', 0.3); 
								   $("div.ajax-loader").hide();         
								}
			        		}
			    });
			 });
		});	
	};
	
	$me.on('click', '.show-files', function(e) {
		e.preventDefault();
		var data = getCheckedCrit();
		data = makeSearchable(data[0]);
		var uristr = data.join('|');
		$viewer.html("").load('/pages/evidence-list/'+uristr, function() {
		  $viewer.show(100);
		  $("div.ajax-loader").hide();
	       }); 			
	});
	
	var getCheckedCrit = function() {
		var map = [];
		var pracsot = [];
			var selStr = "<div class='file-viewer-inner scrollbar'><p><strong>This piece of evidence will be provided for the following criteria at level "+levelName+"</strong></p>";
			$('input:checked').each(function(is, io) {
				$(io).attr("checked", "true");
				var d = $(io).data('criteria');
			    var p = $(io).closest('p').data('pracsot');
				if(typeof p != 'undefined' && null != p && p.length > 0) {
					p = p.trim();
					d.pracsot = p;
			 		if(-1 == map.indexOf(d))
					{	
						map.push(d); 
					}
					if(-1 == pracsot.indexOf(p)) {
			    		pracsot.push(p);
					}
					selStr += "<p>"+$(io).parent().html()+"</p>";
				}
			});
			selStr += "</div>";
	return [map, selStr, pracsot];
	};
	
	/*var getPracsotIDs = function(map) {
		
	};*/
	
	var makeSearchable = function(map) {
		var newMap = [];
		$(map).each(function(i, ar) {
			var str = 'c';
			$(ar).each(function(i, obj){
				str += String(obj.step)+String(obj.level)+String(obj.row)+String(obj.checkbox);
			});
			newMap.push(str);
		}
		);
		return newMap;
	};
	
	$viewer.on('mousedown', 'div.file-info', function(e) {			
			$(e.target).showCriteria();
	}).on('mouseup', 'div.file-info', function(e) {
		console.log('mouseleave');
		$(e.target).removeCriteria();
	});
    
    /* scoped to document for earlier version of Mozilla */
	$(document).on('click', 'div.file-viewer a.exit', function(e) {
			e.preventDefault();
			$(this).closest('div.file-viewer').hide(100);
			$('.feedback, .evidencing-app').fadeTo('slow', 1.0); 
	}); 
	
	$me.ajaxStart(function(){
	    $("div.ajax-loader").show();
	 }).ajaxStop(function(){
	    $("div.ajax-loader").hide();
	 });
		
	$(this).on('click', 'a.getPracsot', function(event) {
		event.preventDefault();
		
		var matrixS = $(this).parent().prevAll('label').text();
		$pracsot_viewer.html("<a href='#close' class='exit'><img src='/img/close-icon.png' alt='close'></a><h3>PRACSOT Performance Criteria Details</h3><p><em>These are the PRACSOT Performance Criteria that this Evidencing Matrix competency statement is fulfilling.</em></p><h4>Evidencing Matrix Competency Statement</h4><p>"+matrixS+"</p><div class='file-viewer-inner'></div>");
		
		var array = [];
		
		$.get('/pracsot/select-pracsot?ids='+$(event.target).attr('href'), function(data) {
			array = JSON.parse(data);
				
			$pracsot_viewer.find('.file-viewer-inner').html('').append("<table><tbody>");
			$(array).each(function(i,v) {
				var elprefix = v.id.match(/[^.]*.[^.]*/);
				$pracsot_viewer.find('.file-viewer-inner').append("<tr><td><a href='/pracsot/pracsot-unit-table?element="+elprefix+"#"+v.id+"' target='_blank'>"+v.id+"</a></td><td>"+v.question+"</td></tr>");
			});
			$pracsot_viewer.find('.file-viewer-inner').append("</tbody></table>");
			$pracsot_viewer.show();
		});
	});
	
	$me.on('change', '#table-nav', function() {
	     var selectedTableId = $('option:selected', this).data("tableid");
        $("table:eq("+selectedTableId+") td p[data-pracsot]").each(function() { $(this).additionalCellInfo(selectedTableId); });
        $("table:eq("+selectedTableId+") a").first().focus();  
	});

	$('#table-nav').trigger('change');
	// add evidence view
	if(entry_id == 'add_evidence') {
		add_evidence();
	}
};

})( jQuery );

$(document).ready(function() {
	
	window.userProfile = {
				"reflections" : {"general-diary-entry":{"internalId":"3364","text":"Another test","date":"1390352438","tag":"general-diary-entry"}},
				"startNewCycle" : false,
				"steps" : ["2","3","6","8"],
				"level" : 1,
				"beginner" : 0,
                "objectives" : [{"text":"Type your learning objectives here in your own words.","competencyStatementID":["otca-2_6_1_0","otca-2_9_1_0","otca-2_13_1_0"],"steps":["2","6"],"competencyStatementText":["Identifies the thinking that contributes to decision making when information gathering","Describes independently the sharing of information gathered with relevant team members and others ","Describes the documentation policy and writes draft case notes for educator"],"pracsot":["7.1.2","5.2.2","5.3.1"],"planning":"Write your objective in this box"}],
				"history_id" : 117,
				"title" : "Pauls Cycle",
				"time" : 1365462064
			};
			window.stepDefinitions = [ "null", "Request for Service", "Information Gathering", "Occupational Assessment", "Identification of Occupational Issues", "Goal Setting", "Intervention",

                                           "Evaluation", "Being a Professional"  ]; 

window.USE_VERIFICATION = false;   
window.assessed_items = [];
window.self_assessed_item = [{"is_current_entry":false,"entry_date":"Mon, June 17, 2013","entry_id":"967","title":"Testing this","group_id":"1","self_assessment":"[{\"step\":2,\"row\":3,\"level\":1,\"checkbox\":0,\"pracsot\":\"1.1.2,2.1.2,2.1.3\"},{\"step\":2,\"row\":3,\"level\":2,\"checkbox\":0,\"pracsot\":\"1.1.2,2.1.2,2.1.3\"}]","step":"","level":""},{"is_current_entry":false,"entry_date":"Fri, May 31, 2013","entry_id":"408","title":"Some evidence","group_id":"1","self_assessment":"[{\"step\":0,\"row\":3,\"level\":0,\"checkbox\":2,\"pracsot\":\"1.6.1, 4.3.3\"},{\"step\":0,\"row\":3,\"level\":0,\"checkbox\":3,\"pracsot\":\"1.2.1, 1.2.3, 1.2.6, 6.1.3\"},{\"step\":0,\"row\":3,\"level\":0,\"checkbox\":4,\"pracsot\":\"7.2.5\"},{\"step\":0,\"row\":3,\"level\":1,\"checkbox\":5,\"pracsot\":\"3.3.9\"}]","step":"","level":""},{"is_current_entry":false,"entry_date":"Fri, November 22, 2013","entry_id":"1351","title":"Test this","group_id":"1","self_assessment":"[{\"step\":0,\"row\":3,\"level\":1,\"checkbox\":1,\"pracsot\":\"1.3.1\"},{\"step\":0,\"row\":3,\"level\":1,\"checkbox\":2,\"pracsot\":\"1.7.2\"},{\"step\":4,\"row\":5,\"level\":1,\"checkbox\":0,\"pracsot\":\"2.2.2\"},{\"step\":4,\"row\":5,\"level\":2,\"checkbox\":0,\"pracsot\":\"2.2.2\"}]","step":"Being a Professional, Identification of Occupational Issues","level":"Emerging, Consolidating"}];

var cycleGroups = [];
cycleGroups[0] = { gradient: new Rainbow(), uids: [967,408, 1252, 1351] };
cycleGroups[0].gradient.setNumberRange(1, cycleGroups[0].uids.length);
cycleGroups[0].gradient.setSpectrum('#aaffaa', 'white');

cycleGroups[1] = { gradient: new Rainbow(), uids: [967, 1351, 408] };
cycleGroups[1].gradient.setNumberRange(1, cycleGroups[1].uids.length);
cycleGroups[1].gradient.setSpectrum('#ffaaaa', 'white');

cycleGroups[2] = { gradient: new Rainbow(), uids: [1252, 1351, 408] };
cycleGroups[2].gradient.setNumberRange(1, cycleGroups[2].uids.length);
cycleGroups[2].gradient.setSpectrum('#aaaaff', 'white');	
	
	$.fn.addColorCoding = function() {
		if(typeof $(this).data('uixsa') === 'undefined' || $(this).data('uixsa').length === 0) return false; 
		
		var tableId = $('#table-nav option:selected').data("tableid");
		if(typeof tableId === 'undefined') tableId = 0;
		
    	var color = $(this).css('background-color');
    	var self_assessments = JSON.parse($(this).data('uixsa'));

    	var cells = $("table:eq("+tableId+") input[type='checkbox']").filter(function() {
    		var disTD = this;
    		var foundMatch = false;
    		$(self_assessments).each(function(i, o) {
	    			if($(disTD).data('criteria').row == o.row && 
	    			$(disTD).data('criteria').level == o.level && 
	    			$(disTD).data('criteria').checkbox == o.checkbox &&
	    			$(disTD).data('criteria').step == o.step) {
	    				console.log(color+" "+JSON.stringify($(disTD).data('criteria')));
	    				foundMatch = true;
	    				return false;
	    			}
    		});
    		return foundMatch;
    	});
    	
    	if(tableId == 0) {
    		$(cells).closest('p').css({'background-color' : color });
    	} else {
    		$(cells).closest('td').css({'background-color' : color });
    	}
    	return this;
	};
	
	/* populate portfolio history*/
	$(self_assessed_item).each(function(i, o) {
		var ul = $("<ul></ul>");
    	var li = $("<li title='Click to view each criteria for this snapshot'>"+o.title+" &ndash; "+o.entry_date+"</li>");
    	
    	var color = '';
  		$(cycleGroups).each(function(i,v) {
  			var ci = $.inArray(Number(o.entry_id), this.uids);
  			var classN = 'cgid_'+i;
  			
  			if(ci !== -1) {
  				var groupUL = $('#portfolio_interface ul.'+classN);
  				
  				if(groupUL.length == 0) {
	  				ul.addClass(classN).addClass('cycleGroup');
	  				$('#portfolio_interface').append(ul);
	  				groupUL = ul;
  				}
  				$(groupUL).append(li);
  				
  				color = this.gradient.colourAt(ci);
  				return false;
  			}
  		});
    	
    	$(li).css({ "background-color" : "#"+color}).data('uixsa', o.self_assessment);
    });
    
    $('.evidencing-app').evidencing();
    var setMatrixColors = function() {
    	$("#portfolio_interface li").each(function() {$(this).addColorCoding();});
    };
    setMatrixColors();
    
    /* additional color coding function */
	$(document).on('change', '#table-nav', function() {
		setMatrixColors();
		var tableId = $('#table-nav option:selected').data("tableid");
		$('table:eq('+tableId+')').trigger('change');
	});
	
    $(document).on('mouseover', "#portfolio_interface li", function() {
    	if(typeof $(this).data('uixsa') === 'undefined' || $(this).data('uixsa').length === 0) return false; 
    	
    	var tableId = $('#table-nav option:selected').data("tableid");
    	//var item = $(this).data('mxdata');
    	var color = $(this).css('border-color');
    	var self_assessments = JSON.parse($(this).data('uixsa'));
    	//console.log(self_assessments);
    	var cells = $("table:eq("+tableId+") input[type='checkbox']").filter(function() {
    		var disTD = this;
    		var foundMatch = false;
    		$(self_assessments).each(function(i, o) {
	    			if($(disTD).data('criteria').row == o.row && 
	    			$(disTD).data('criteria').level == o.level && 
	    			$(disTD).data('criteria').checkbox == o.checkbox &&
	    			$(disTD).data('criteria').step == o.step) {
	    				console.log(color+" "+JSON.stringify($(disTD).data('criteria')));
	    				foundMatch = true;
	    				return false;
	    			}
    		});
    		return foundMatch;
    	});
    	
    	if(tableId == 0) {
    		$(cells).closest('p').css({'border' : '5px solid '+color, 'padding': 0});
    	} else {
    		$(cells).closest('td').css({'border' : '5px solid '+color, 'padding' : 0});
    	}
    }).on('click', "#portfolio_interface li", function() {
    	
    	console.log("Clicked>>> "+$(this).data('uixsa'));
    	if(typeof $(this).data('uixsa') === 'undefined' || $(this).data('uixsa').length === 0) return false; 
    	
    	/* go to next available criteria for this snapshot */
    	var self_assessments = JSON.parse($(this).data('uixsa'));
    	var color = $(this).css('border-color');
    	
    	var getFirstFoundTD = function() {
    	var firstCell = [];
    	$("table input[type='checkbox']:not(.lastFound)").each(function() {
    		var disTD = this;
    		var foundMatch = false;
    		
		    		$(self_assessments).each(function(i, o) {
			    			if($(disTD).data('criteria').row == o.row && 
			    			$(disTD).data('criteria').level == o.level && 
			    			$(disTD).data('criteria').checkbox == o.checkbox &&
			    			$(disTD).data('criteria').step == o.step) {
			    				firstCell.push(disTD);
			    				$(disTD).addClass('lastFound');
			    				return false;
			    			}
		    		});
		    		
		    if(firstCell.length > 0) {
		    	return false;
		    }
    	});
    	
    	return firstCell;
    	};
    	
    	var cells = getFirstFoundTD();
    	var index = 0;
    	
    	if(cells.length > 0) {
    		var tid = $(cells).first().closest('table');
    		
    		$('table').each(function(i,v) {
    			if($(tid)[0] == $(this)[0]) {
    				index = i;
    				return false;
    			}
    		});
    		console.log(index);
    		$("select#table-nav").val(index).trigger('change');
    		
    		cells[0].scrollIntoView();
    		$(cells[0]).closest('p').fadeOut(300).fadeIn(300).fadeOut(300).fadeIn(300);
    	} else {
    		$("table input[type='checkbox'].lastFound").removeClass('lastFound');
    		$(this).trigger('click');
    	}
    	
    	if(index == 0) {
    		$(cells[0]).closest('p').css({'border' : '5px solid '+color, 'padding': 0});
    	} else {
    		$(cells[0]).closest('td').css({'border' : '5px solid '+color, 'padding' : 0});
    	}
    	
    }).on('mouseleave', "#portfolio_interface li", function() { 
    	var tableId = $('#table-nav option:selected').data("tableid");
    	var cells = $("table:eq("+tableId+") input[type='checkbox']"); //.closest('p').css({'background-color' : 'transparent'});
    	
    	if(tableId == 0) {
    		$(cells).closest('p').css({'border' : '5px solid transparent'});
    	} else {
    		$(cells).closest('td').css({'border' : '5px solid transparent'});
    	}
    });
    
    $.fn.doResize = function() {
    
     /* reset table */
     if($(window).width() > 601) {
     		$("#portfolio_interface").addClass('fixed_220w');
     		$("#matrix_heading").addClass('fixed_lm220');
     		$("#matrix_interface").css({'margin-left': '238px'});
     		scale = 0;
     		last = 0;
     		$("td,th").show(500);	
     		
     		/* use original colspan */
     		$("td[colspan], th[colspan]").each(function() {
     		 	var myspan = $(this).data('cspan');
     		 	$(this).attr('colspan', myspan);
     		});
     }
    
    var removeFixedLayout = function() {
    	if($(window).width() > 601) return false;
    
    	$("#portfolio_interface").removeClass('fixed_220w');
     	$("#matrix_heading").removeClass('fixed_lm220');
     	$("#matrix_interface").css({'margin-left': '0'});
    };
    
	if($(window).width() < last) {
		removeFixedLayout();
		$("td:not([colspan]):last-of-type, th:not([colspan]):last-of-type").hide();
		console.log('hiding');		
	}
	if($(window).width() > last) {
		removeFixedLayout();
		$("td:not([colspan]):last-of-type, th:not([colspan]):last-of-type").show();
	}
		
	last = $(window).width();
	
	return this;
    };
    
    $.fn.adjustColspans = function() {
    		var tableId = $('#table-nav option:selected').data("tableid");
    		var ncols = $("table:eq("+tableId+") tr:first-of-type th").filter(":visible").length;
    		
			console.log("nocols: "+ncols);
			$("th[colspan], td[colspan]").each(function() {
					var ofs = $(this).index() == -1 ? 0 : $(this).index();
					$(this).attr('colspan', ncols - ofs);
			});
			
	return this;
    };
    
    $.fn.addButtons = function() {
     		var tableId = $('#table-nav option:selected').data("tableid");
    		var ncols = $("table:eq("+tableId+") tr:first-of-type th").filter(":not(:visible)").length;
    		
    		$("#device_msg").remove();
    		if(ncols > 0) {
    			$('.evidencing-app #table-nav').after("<p id='device_msg' style='font-size: 9px'>Due to the width of your screen, a column has been hidden.  <button id='show_hidden'>Show hidden column</button></p>");
    		}
    return this;	
    };
    
    $(document).on('click', '#show_hidden', function() {
   		 var tableId = $('#table-nav option:selected').data("tableid");
 		$("table:eq("+tableId+") td, table:eq("+tableId+") th").filter(':not(:visible)').addClass('jht').show(); 
 		
 		if($("td.jht, th.jht").next('td,th').length > 0) {
 			$('td.jht, th.jht').removeClass('jht').next('th, td').hide();  
 		} else {
 			$('td.jht, th.jht').removeClass('jht').prev('th, td').hide();  
 		}  			
    });
    
    
     var last = 9999;
     
     $("td[colspan], th[colspan]").each(function() {
     			var cspan = $(this).attr('colspan');
     			$(this).data('cspan', cspan);
     });
     
     $(window).on('resize', function() {
     	console.log('resizing');
     	$(this).doResize().adjustColspans().addButtons();
     });
     
     $('table').on('change', function() {
     	$(this).doResize().adjustColspans().addButtons();
     });
	$(window).trigger('resize');
});


</script>
</body>
</html>